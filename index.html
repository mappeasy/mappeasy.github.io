<!DOCTYPE html>
<html>

<head>
    <title>Leaflet Map with OpenStreetMap Nominatim Geocoding</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        body,
        html {
            padding: 0;
            margin: 0;
            height: 100%;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .search-box {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 5px;
        }

        #search-input {
            padding: 5px;
            width: 300px;
            background: rgba(255, 255, 255, 0.5);
        }

        .gps-switch-container {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }

        /* The switch - the box around the slider */
        .gps-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* Hide default HTML checkbox */
        .gps-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* The slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked+.slider {
            background-color: #2196F3;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div class="search-box">
        <input type="text" id="search-input" placeholder="Enter an address...">
    </div>
    <div class="gps-switch-container">
        <label class="gps-switch">
            <input type="checkbox" id="gps-toggle">
            <span class="slider round"></span>
        </label>
    </div>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Esri Leaflet -->
    <script src="https://unpkg.com/esri-leaflet"></script>

    <script>
        // Create Leaflet Map
        var map = L.map('map', {
            zoomControl: false, // This will remove the default zoom control
            center: [29.7604, -95.3698],
            zoom: 11
        });

        // Base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Esri layers
        var gravityMainLayer = L.esri.dynamicMapLayer({ url: "https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer", layers: [1] }).addTo(map);
        var gravityMainLabelLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [2] }).addTo(map);
        var manholeLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [12] }).addTo(map);
        var manholeLabelLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [13] }).addTo(map);
        var lsWwtpLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [16] }).addTo(map);
        var lsWwtpLabelLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [17] }).addTo(map);

        // Layer control
        var baseLayers = {
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
        };
        var overlays = {
            "Gravity Main": gravityMainLayer,
            "Gravity Main Labels": gravityMainLabelLayer,
            "Manholes": manholeLayer,
            "Manhole Labels": manholeLabelLayer,
            "Lift Stations": lsWwtpLayer,
            "Lift Station Labels": lsWwtpLabelLayer
        };
        L.control.layers(baseLayers, overlays, { position: 'bottomright' }).addTo(map);

        // Nominatim Geocoding
        var marker;
        function geocode() {
            var input = document.getElementById('search-input').value;
            var url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        var place = data[0];
                        if (marker) {
                            map.removeLayer(marker);
                        }
                        marker = L.marker([place.lat, place.lon]).addTo(map);
                        marker.bindPopup('<b></b><br>' + data[0].display_name).openPopup();
                        map.setView([place.lat, place.lon], 15);
                    } else {
                        alert("Address not found");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Error searching for address");
                });
        }
        document.getElementById('search-input').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                geocode();
            }
        });

        function updateLayerVisibility() {
            var currentZoom = map.getZoom();
            console.log("Current Zoom Level:", currentZoom);
            var isVisibleFeature = currentZoom >= 15;
            var isVisibleLabel = currentZoom >= 17;

            // Toggle each layer based on zoom level
            gravityMainLayer.setOpacity(isVisibleFeature ? 1 : 0);
            manholeLayer.setOpacity(isVisibleFeature ? 1 : 0);
            lsWwtpLayer.setOpacity(isVisibleFeature ? 1 : 0);
            gravityMainLabelLayer.setOpacity(isVisibleLabel ? 1 : 0);
            manholeLabelLayer.setOpacity(isVisibleLabel ? 1 : 0);
            lsWwtpLabelLayer.setOpacity(isVisibleLabel ? 1 : 0);
        }
        // Attach the function to the map's zoomend event
        map.on('zoomend', updateLayerVisibility);

        // Call the function initially to set the correct visibility
        updateLayerVisibility();

        var gpsMarker;
        var watchID;
        var humanIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/mappeasy/mappeasy.github.io/main/person_map_blue.svg',
            iconSize: [18, 30],
            iconAnchor: [18, 30],
            popupAnchor: [0, -30]
        });
        document.getElementById('gps-toggle').addEventListener('change', function () {
            if (this.checked) {
                startGPSTracking();
            } else {
                stopGPSTracking();
            }
        });
        function startGPSTracking() {
            if (navigator.geolocation) {
                watchID = navigator.geolocation.watchPosition(function (position) {
                    var latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                    if (!gpsMarker) {
                        gpsMarker = L.marker(latlng, { icon: humanIcon }).addTo(map);
                    } else {
                        gpsMarker.setLatLng(latlng);
                    }
                    map.setView(latlng, map.getZoom());
                }, function (err) {
                    console.warn(`ERROR(${err.code}): ${err.message}`);
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function stopGPSTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.clearWatch(watchID);
            }
            if (gpsMarker) {
                map.removeLayer(gpsMarker);
                gpsMarker = null;
            }
        }
    </script>

</body>

</html>
