<html>

<head>
    <title>Flush FLow Frenzy: Follow the FLush </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="flushflow.css" />
    <!-- Leaflet Esri Plugin -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet"></script>
    <!-- JavaScript file -->
    <script src="script.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BHSNBW8NK6"></script>
    <script>
        try {
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());

            gtag('config', 'G-BHSNBW8NK6');
        } catch (e) {
            console.log(e);
        }
    </script>
</head>

<body>
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Following The Flush . . .</h2>
                <i class="fa fa-cog fa-spin fa-5x fa-fw"></i>
            </div>
            <div class="modal-body">
                <p style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <span style="color: #007bff; font-weight: bold;">Dive into Houston's hidden water kingdom!</span>
                    Imagine <span style="font-weight: bold;">39 bustling wastewater castles</span> and <span
                        style="font-weight: bold; color: #28a745;">2 special rain spas.</span>
                    <br />Picture over <span style="font-weight: bold;">380 water elevators</span> (no boring music
                    here!) and a whopping <span style="font-weight: bold;">6,500 miles of watery roads,</span> from tiny
                    2-inch streams to huge 144-inch rivers.
                    <br />These pipes could stretch <span style="font-weight: bold;">from DC to Seattle and back</span>
                    â€“ it's a mega water slide under your feet!
                    <br /> <span style="color: #dc3545; font-weight: bold;">Houston's not just a city, it's an epic H2O
                        adventure land!</span> ðŸŒŠðŸš€ðŸ’¦
                </p>
            </div>
        </div>
    </div>
    <div id="summaryCard" class="summary-card">
        <div class="card-note" id="card-note-notification">From Flush to Final Splash! Adventure Begins</div>
        <!-- Add your note text here -->
        <div class="card-content">
            <h2 id="cardHeader">Where Flush Goes</h2>
            <sub id="notification">
                <font color='gray'><i>"Imagine this: In our underground water race, the flow zooms from 1 to 3 feet per
                        second in the Gravity Main, like a lazy river, and then dashes from 2 to 8 feet per second in
                        the Forcemain, like a super-speedy waterslide!</i></font>
            </sub>
            <hr />
            <p id="generalRoute_container"><strong>General Route:</strong> <span id="generalRoute">0 feet</span></p>
            <p id="distanceTraveled_container"><strong>Zooming Adventure:</strong> <span id="distanceTraveled">0
                    feet</span></p>
            <p id="timeToWWTP_container"><strong>Speedy Splash:</strong> <span id="timeToWWTP">0 hours</span></p>
            <p id="communitiesPassed_"><strong>Epic Journey of the Flush:</strong></p>
            <ul id="communitiesPassed">
                <!-- List items will be added dynamically -->
            </ul>
            <button onclick="closeSummaryCard('summaryCard');">Close</button>

        </div>
    </div>
    <div id="aboutMe" class="summary-card">
        <div class="card-note">Flush Flow Frenzy: Follow the Flush</div>
        <!-- Add your note text here -->
        <div class="card-content">
            <h2 id="cardHeader_about">About this Project</h2>
            <p id="generalRoute_container_about"><span id="generalRoute_about">This is purely for learning purpose â€“ a
                    chance to track the splashy journey of our flushes from the loo to the lab! It's our way of teaching
                    the kiddos the swirling path of their flush â€“ from toilet twirls to treatment thrills! ðŸš½ðŸ’¦ðŸŽ¢ <br />
                    Double Click/Tap to flush ðŸ’©</span></p>
            <p id="distanceTraveled_container_about"><span id="distanceTraveled_about">Made with <i
                        class="fa-solid fa-heart" style="color: #d31717;"></i> by WWO<br></span></p>
            <button onclick="closeSummaryCard('aboutMe')">Close</button>
        </div>
    </div>
    <div id="splashShow" class="summary-card">
        <div class="card-note">Flush Flow Frenzy: Follow the Flush</div>
        <!-- Add your note text here -->
        <div class="card-content">
            <h2 id="cardHeader_about">Flushing ðŸ’©: Super Simple </h2>
            <p id="generalRoute_container_about"><span id="generalRoute_about"> <b style="color: red;">Double Tap or
                        double click</b> on any spot to start a flush adventure, or hit the blue top-left button to
                    whoosh away from where you are!ðŸš½ðŸ’¦ðŸŽ¢</span></p>
            <p id="distanceTraveled_container_about"><span id="distanceTraveled_about">Made with <i
                        class="fa-solid fa-heart" style="color: #d31717;"></i> by WWO<br></span></p>
            <button onclick="closeSummaryCard('splashShow')">Close</button>
        </div>
    </div>
    <div id="map"></div>
    <button id="currentLocationButton" title="Your Current Location"><i class="fa fa-location"></i></button>
    <button id="lastFlushButton"><i class="fas fa-water"></i> Last Flush</button>
    <div id="toggleButton" class="collapsible-button"> <i class="fas fa-chevron-down"></i> More <i
            class="fa-solid fa-poo fa-beat" style="color: #8b4513;"></i></div>
    <div id="scoreContainer" style="position: absolute; top: 10px; left: 10px; z-index: 1000; display: none;">
        <i class="fa-solid fa-gem fa-bounce fa-2x" style="color: #db1414;"></i>
        <span id="score">0</span>
    </div>             
    <div id="legendContent" class="legend-content">
        <h4>Map Legend</h4>
        <table class="icon-text-table">
            <tr>
                <td><i class="fa-solid fa-minus fa-flip fa-2xl" style="color: #B197FC;"></i></td>
                <td>Flush Path</td>
            </tr>
            <tr>
                <td><i class="fa-solid fa-pump-soap fa-beat fa-2x" style="color: #ed0c0c;"></i></td>
                <td>LS</td>
            </tr>
            <tr>
                <td><i class="fa-solid fa-city fa-beat fa-2x" style="color: #120FE6;"></i></td>
                <td>WWTP</td>
            </tr>
            <tr>
                <td><i class="fa-solid fa-minus fa-2xl" style="color: #e60a0a;"></i></td>
                <td>Sewer Lines</td>
            </tr>
            <tr>
                <td><i class="fa-regular fa-circle"></i></td>
                <td>Sewer Manholes</td>
            </tr>
        </table>

        <hr />
        <div class="switch-container">
            <input type="checkbox" class="toggle-switch-checkbox" id="manholeToggle">
            <label class="toggle-switch-label" for="manholeToggle"></label>
            <h4>&nbsp;More Labels</h4>
        </div>
        <div class="switch-container">
            <input type="checkbox" class="toggle-switch-checkbox" id="onlyFlush">
            <label class="toggle-switch-label" for="onlyFlush"></label>
            <h4>&nbsp;Only Flushnbsp</h4>
        </div>
        <hr />
        <div class="switch-container">
            <input type="checkbox" class="toggle-switch-checkbox" id="gameOn">
            <label class="toggle-switch-label" for="gameOn"></label>
            <h4>&nbsp;Game On</h4>
        </div>
        <hr />
        <!-- About button -->
        <button id="aboutButton" class="legend-button">About</button>
        <div><i style="font-size:14px; ">For Kiddos Learning Only</i></div>
        <!-- Toggle switch for manhole layers -->
    </div>

    <script>
        document.getElementById('scoreContainer').style.display = 'none';
        function adjustMapHeight() {
            var mapElement = document.getElementById('map');
            var windowHeight = window.innerHeight;
            mapElement.style.height = windowHeight + 'px';
        }

        // Adjust the height on initial load
        adjustMapHeight();

        // Adjust the height whenever the window is resized
        window.addEventListener('resize', adjustMapHeight);
        document.getElementById('legendContent').style.display = 'none';
        document.getElementById('toggleButton').onclick = function () {
            var contentDiv = document.getElementById('legendContent');
            var isHidden = contentDiv.style.display === 'none';
            contentDiv.style.display = isHidden ? 'block' : 'none';

            var icon = this.querySelector('i');
            if (isHidden) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        };

        document.getElementById('aboutButton').onclick = function () {
            closeSummaryCard('summaryCard');
            document.getElementById('aboutMe').style.display = 'block';
        };

        document.getElementById('manholeToggle').onchange = function () {
            toggleManholeLayers();
        };

        document.getElementById('onlyFlush').onchange = function () {
            toggleOnlyFlush();
        };
        document.getElementById('gameOn').onchange = function () {
            if (this.checked) {
                // Enable map click for the game
                map.on('click', gameClickHandler); // gameClickHandler is your function to handle map clicks for the game
                showScoreLabel(true); // Show the score label
                if (geojsonData_game!==null) 
                {
                    try{
                        clearAllGoldMarkers();
                    }catch(e){
                        console.log(e);
                    }
                    addGoldMarkers(geojsonData_game);
                }
            } else {
                // Disable map click for the game
                map.off('click', gameClickHandler);
                showScoreLabel(false); // Hide the score label
                try{
                    clearAllGoldMarkers();
                }catch(e){
                    console.log(e);
                }
            }
        };
        // Configuration
        const config = {
            esri_basemap: false,
            mapCenter: [29.76, -95.37], // Houston's coordinates
            initialZoom: 13,
            layerTransparency: 0.4,
            layerTransparencyView: 1,
            minimumZoomLevel: 16,
            zoomControl: false,
            maxZoom: 19,
            geoJsonStyle: {
                color: "#0000FF",
                weight: 8,
                opacity: 0.4
            }
        };
        var mainData = {
        };;
        makeDraggable([document.getElementById('cardHeader'), document.getElementById('notification')], document.getElementById('summaryCard'));
        makeDraggable([document.getElementById('cardHeader_about')], document.getElementById('aboutMe'));
        closeSummaryCard('aboutMe');
        closeSummaryCard('summaryCard');
        var currentGeoJsonLayer = null;
        var currentLocationIcon = null;
        var currentLocationIcoSpin = null;
        var currentGeoJsonLayerLine = null;         
        var goldMarkers = [];
        var geojsonData_game = null;
        var score = 0; // Initialize score
        document.getElementById("loadingModal").style.display = "none";
        // Initialize Map
        const map = L.map('map', {
            center: config.mapCenter,
            zoom: config.initialZoom,
            maxZoom: config.maxZoom,
            zoomControl: config.zoomControl // Disable the default zoom control
        });

        // Add a toilet marker
        var toiletIcon = L.divIcon({
            className: 'fa-icon',
            html: '<i class="fa-solid fa-poo fa-3x fa-beat" style="color: #8b4513;"></i>',
            iconSize: [30, 30], // size of the icon in pixels
            iconAnchor: [10, 20] // point of the icon which will correspond to marker's location
        });
        var gemIcon = L.divIcon({
            className: 'fa-icon',
            html: '<i class="fa-solid fa-gem fa-bounce fa-2x" style="color: #db1414;"></i>',
            iconSize: [30, 30], // size of the icon in pixels
            iconAnchor: [10, 20] // point of the icon which will correspond to marker's location
        });
        var spinLocation = L.divIcon({
            className: 'fa-icon',
            html: '<i class="fa-solid fa-crosshairs fa-spin fa-2xl" style="color: #007bff;"></i>',
            iconSize: [30, 30], // size of the icon in pixels
            iconAnchor: [0, 15] // point of the icon which will correspond to marker's location
        });
        var pumpIcon = L.divIcon({
            className: 'fa-icon',
            html: '<i class="fa-solid fa-pump-soap fa-beat fa-3x" style="color: #ed0c0c;"></i>',
            iconSize: [30, 30], // size of the icon in pixels
            iconAnchor: [10, 20] // point of the icon which will correspond to marker's location
        });
        var wwtpIcon = L.divIcon({
            className: 'fa-icon',
            html: '<i class="fa-solid fa-city  fa-3x  fa-beat" style="color: #120FE6;"></i>',
            iconSize: [30, 30], // size of the icon in pixels
            iconAnchor: [10, 20] // point of the icon which will correspond to marker's location
        });

        if (config.esri_basemap === true) {
            L.esri.basemapLayer('Streets').addTo(map);
        }
        else {
            //L.esri.basemapLayer('Streets').addTo(map);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Not for official use or planning | <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11', // or any other Mapbox style
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoibWF0aGhvYW5nIiwiYSI6ImNsc3I2djRwYjE1ODYyanBiZ2E1djltbDkifQ.nqI0jOWkftuTKgHx6m8mcw' // Replace with your Mapbox access token
            }).addTo(map);
        }
        // Layer Definitions
        const gravityMainLayer = createEsriLayer("https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer", [1], config.layerTransparency, true);
        const forceMainLayer = createEsriLayer("https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer", [4], config.layerTransparency, true);
        const lsWwtpLayer = createEsriLayer('https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', [16], config.layerTransparency, true);
        const lsWwtpLabelLayer = createEsriLayer('https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', [17], config.layerTransparency, true);

        const gravityMainLayerlabel = createEsriLayer("https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer", [2], config.layerTransparency, false);
        const manholeLayer = createEsriLayer('https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', [12], config.layerTransparencyView, false);

        const manholeLayerLabel = createEsriLayer('https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', [13], config.layerTransparencyView, false);


        // Utility Functions
        function createEsriLayer(url, layers, opacity, addIn) {
            if (addIn === true) {
                return L.esri.dynamicMapLayer({ url, layers, opacity }).addTo(map);
            } else {
                return L.esri.dynamicMapLayer({ url, layers, opacity });

            }
        }
        document.getElementById('lastFlushButton').addEventListener('click', function () {
            if (Object.keys(mainData).length === 0) {
                var NoData = {
                    header: "Ready, Set, Flush! Double Click/Tap anywhere on the map to start a watery whirlwind adventure!", // Add your header text here
                    distance: 'Flush to see the journey',
                    time: 'Flush to travel in time',
                    communities: ['Traveling']
                };
                showSummaryCard(NoData, true);
            } else {
                showSummaryCard(mainData, false);
            }
        });
        
        function showSummaryCard(data, notification) {
            if (notification === false) {
                document.getElementById('distanceTraveled_container').style.display = '';
                document.getElementById('timeToWWTP_container').style.display = '';
                document.getElementById('communitiesPassed').style.display = '';
                document.getElementById('card-note-notification').style.display = '';
                document.getElementById('notification').style.display = '';
                document.getElementById('communitiesPassed_').style.display = '';
                document.getElementById('generalRoute_container').style.display = '';
                // Populate the summary card with data
                // Populate the summary card with data
                document.getElementById('cardHeader').textContent = data.header;
                document.getElementById('distanceTraveled').textContent = data.distance;
                document.getElementById('timeToWWTP').textContent = data.time;
                document.getElementById('generalRoute').textContent = data.generalRoute;
                document.getElementById('communitiesPassed').innerHTML = data.communities.map(c => `<li>${c}</li>`).join('');
            } else {
                document.getElementById('cardHeader').textContent = data.header;
                document.getElementById('distanceTraveled_container').style.display = 'none';
                document.getElementById('timeToWWTP_container').style.display = 'none';
                document.getElementById('communitiesPassed').style.display = 'none';
                document.getElementById('card-note-notification').style.display = 'none';
                document.getElementById('notification').style.display = 'none';
                document.getElementById('communitiesPassed_').style.display = 'none';
                document.getElementById('generalRoute_container').style.display = 'none';
            }
            // Show the summary card
            document.getElementById('summaryCard').style.display = 'block';
        }

        function closeSummaryCard(cardName) {
            document.getElementById(cardName).style.display = 'none';
        }

        function showModal() {
            document.getElementById('loadingModal').style.display = 'flex'; // Use 'flex' to enable flexbox properties
        }
        function hideModal() {
            document.getElementById('loadingModal').style.display = 'none';
        }
        let manholeLayersAdded = false;
        function toggleManholeLayers() {
            if (manholeLayersAdded) {
                map.removeLayer(manholeLayer);
                map.removeLayer(manholeLayerLabel);
                map.removeLayer(gravityMainLayerlabel);
                config.layerTransparency = 0.4;
                setLayerVisibility(config.layerTransparency);
                if (document.getElementById('onlyFlush').checked === true) {
                    document.getElementById('onlyFlush').checked = false;
                    toggleOnlyFlush();
                }
            } else {
                manholeLayerLabel.addTo(map);
                manholeLayer.addTo(map);
                gravityMainLayerlabel.addTo(map);
                map.removeLayer(gravityMainLayer);
                gravityMainLayer.addTo(map); //well! this is to bring the gravityMainLayer to the bottom
                map.removeLayer(forceMainLayer);
                forceMainLayer.addTo(map);   //well! this is to bring the forceMainLayer to the bottom              
                config.layerTransparency = 1;
                setLayerVisibility(config.layerTransparency);
            }
            manholeLayersAdded = !manholeLayersAdded;
        }
        let onlyFlush = false;
        toggleOnlyFlush(onlyFlush);
        function toggleOnlyFlush() {
            if (onlyFlush) {
                map.removeLayer(manholeLayer);
                map.removeLayer(manholeLayerLabel);
                map.removeLayer(gravityMainLayerlabel);
                map.removeLayer(gravityMainLayer);
                map.removeLayer(forceMainLayer);
                map.removeLayer(gravityMainLayerlabel);
                map.removeLayer(lsWwtpLayer);
                map.removeLayer(lsWwtpLabelLayer);
                if (document.getElementById('manholeToggle').checked === true) {
                    document.getElementById('manholeToggle').checked = false;
                    toggleManholeLayers();
                }

            } else {
                gravityMainLayerlabel.addTo(map);
                gravityMainLayer.addTo(map); //well! this is to bring the gravityMainLayer to the bottom
                forceMainLayer.addTo(map);   //well! this is to bring the forceMainLayer to the bottom              
                lsWwtpLayer.addTo(map);   //well! this is to bring the forceMainLayer to the bottom              
                lsWwtpLabelLayer.addTo(map);   //well! this is to bring the forceMainLayer to the bottom                       
            }
            onlyFlush = !onlyFlush;
        }
        function removeAllLayer() {
            try {
                if (currentGeoJsonLayer !== null) map.removeLayer(currentGeoJsonLayer);
                if (LScurrentMarker !== null) map.removeLayer(LScurrentMarker);
                if (WWTPcurrentMarker !== null) map.removeLayer(WWTPcurrentMarker);
                if (currentGeoJsonLayerLine !== null) map.removeLayer(currentGeoJsonLayerLine);
                if (currentLocationIcon !== null) map.removeLayer(currentLocationIcon);
                if (currentLocationIcoSpin !== null) map.removeLayer(currentLocationIcoSpin);
                if (searchMarker !== null) map.removeLayer(searchMarker);
                try{
                    clearAllGoldMarkers();
                }catch(e){
                    console.log(e);
                }
                LScurrentMarker = null;
                WWTPcurrentMarker = null;
                currentGeoJsonLayer = null;
                currentGeoJsonLayerLine = null;
                currentLocationIcoSpin = null;
            } catch (e) {
                console.log(e);
            }
        }
        // Function to add GeoJSON to the map
        function addGeoJsonToMap(geojsonData) {

            // Remove the previous GeoJSON layer if it exists
            removeAllLayer();

            currentGeoJsonLayer = L.geoJSON(geojsonData, {
                style: function (feature) {
                    return {
                        color: config.geoJsonStyle.color, // Example color
                        weight: config.geoJsonStyle.weight,
                        opacity: config.geoJsonStyle.opacity,
                        lineCap: 'round',
                        dashArray: '10, 20',
                        dashOffset: '0',
                        className: (feature.properties.SUBTYPECD == 1 || feature.properties.SUBTYPECD == 2) ? 'heavy-traffic-animation' : 'light-traffic-animation'
                    };
                }
            }).addTo(map);

            currentGeoJsonLayerLine = L.geoJSON(geojsonData, {
                style: function (feature) {
                    return {
                        color: "#0000FF",
                        weight: 12,       // Thickness of the line
                        opacity: 0.2     // Transparency
                    };
                }
            }).addTo(map);
            // Zoom to the bounds of the GeoJSON layer
            if (geojsonData.features && geojsonData.features.length > 0) {
                var bounds = currentGeoJsonLayer.getBounds();
                map.fitBounds(bounds);
            }
            let flusingPoint = geojsonData.features[0].geometry.coordinates[0];
            currentLocationIcoSpin = L.marker([flusingPoint[1], flusingPoint[0]], { icon: spinLocation })
                .addTo(map)
            //.bindPopup('Your flush starts here!')
            //.bindTooltip('flush Location', { permanent: true, direction: 'top' })
            //.bindTooltip("Hey!I'm your flush")
            //.openTooltip();            
            currentLocationIcon = L.marker([flusingPoint[1], flusingPoint[0]], { icon: toiletIcon })
                .addTo(map)
                .bindPopup('Your flush starts here!')
            //.bindTooltip('flush Location', { permanent: true, direction: 'top' })
            //.bindTooltip("Hey!I'm your flush")
            //.openTooltip();

        }

        function checkZoomLevel() {
            const currentZoom = map.getZoom();
            console.log(currentZoom);
            if (currentZoom < config.minimumZoomLevel) {
                setLayerVisibility(0); // Hide layers
            } else {
                setLayerVisibility(config.layerTransparency); // Show layers
            }
        }

        function setLayerVisibility(opacity) {
            gravityMainLayer.setOpacity(opacity);
            forceMainLayer.setOpacity(opacity);
            lsWwtpLayer.setOpacity(opacity);
            lsWwtpLabelLayer.setOpacity(opacity);
            gravityMainLayerlabel.setOpacity(opacity);
            manholeLayer.setOpacity(opacity);
            manholeLayerLabel.setOpacity(opacity);
        }
        var LScurrentMarker = null; // This will hold the current marker
        var WWTPcurrentMarker = null; // This will hold the current marker
        async function runTrace(lng, lat) {
            showModal();
            geojsonData_game = null;
            // Remove the previous GeoJSON layer if it exists
            await removeAllLayer();
            try {
                const initialUnitId = await findNearestFeatureUnitId(lng, lat);
                if (initialUnitId) {
                    //15: LS
                    const result = await queryFeaturesAndGetGeoJson(initialUnitId, 98);
                    if (result && result.geojson) {
                        let street = [];
                        let generalRoute = "";
                        addGeoJsonToMap(result.geojson);
                        hideModal();
                        //find first LiftStation
                        let firstLS = result.stopPoints.find(obj => obj.type === 15);
                        if (firstLS != null) {
                            firstLS = await findLSWWTP(firstLS.type, firstLS.unitID);
                        }

                        let lastStopPoint = result.stopPoints[result.stopPoints.length - 1];
                        let lastStopPoint_Result = await findLSWWTP(lastStopPoint.type, lastStopPoint.unitID);
                        if (lastStopPoint_Result == null) { //get
                            lastStopPoint_Result = await findLSWWTP(lastStopPoint.type, lastStopPoint.unitID);
                            for (let i = result.geojson.features.length - 1; i >= 0; i--) {
                                lastStopPoint_Result = await findLSWWTP(result.geojson.features[i].properties.MAINCOMP2, result.geojson.features[i].properties.UNITID2);
                                if (lastStopPoint_Result != null) {
                                    break;
                                }
                            }
                        }
                        if (firstLS == null) {
                            generalRoute = "Guess what happens when you flush? It's like a water race to the 'Clean Team Castle', zooming directly to the treatment plant " + lastStopPoint_Result.info.FACILITYNAME + " at " + lastStopPoint_Result.info.ADDRESS + "for a super splashy makeover";

                        } else {
                            generalRoute = "Every time you flush, it's like a mini-water slide adventure for the water! It zooms down to the 'Super Lift Station' " + firstLS.info.FACILITYNAME + " at " + firstLS.info.ADDRESS + "  then whooshes through secret tunnels all the way to the 'Clean-up Club' WWTP at  " + lastStopPoint_Result.info.ADDRESS;
                            placeMarker(firstLS.location.y, firstLS.location.x, firstLS.info.FACILITYNAME, "LS");
                        }
                        await placeMarker(lastStopPoint_Result.location.y, lastStopPoint_Result.location.x, lastStopPoint_Result.info.FACILITYNAME, "WWTP")
                        let calculation = await calculateRoute(result.geojson.features);
                        mainData = {
                            header: "Near By " + result.geojson.features[0].properties.ADDRESS, // Add your header text here
                            generalRoute: generalRoute,
                            distance: `The flush travels ${calculation.total_len_ft} feet (${calculation.total_len_mi}  miles) through the sewer network before reaching the COH treatment facility.`,
                            time: `Your flush goes on a wild ride! It could zip to the treatment plant in just  ${calculation.total_hour_min} hours, , or take a leisurely journey up to ${calculation.total_hour_max} hours during sunny weather fun times.`,
                            communities: getUniqueStreetNames(result.geojson.features)
                        };
                        geojsonData_game = result.geojson;
                        if(document.getElementById('gameOn').checked === true){
                            addGoldMarkers(result.geojson);
                        }
                        showSummaryCard(mainData, false);
                    } else {
                        console.log('No GeoJSON data found.');
                    }
                } else if (initialUnitId == null || initialUnitId == "") {
                    var noConnection = {
                        header: "Likely, you are not connecting to any City of Houston Sanitary Sewer System", // Add your header text here
                        distance: 'Not Applicable',
                        time: 'Not Applicable',
                        communities: ['Not Available']
                    };
                    hideModal();
                    showSummaryCard(noConnection, true);
                }
            } catch (error) {
                console.error('Error:', error);
            }

        }
        function placeMarker(lat, long, text, type) {
            try {
                if (type == "LS") {
                    markerOptions = { icon: new L.Icon.Default() };
                    LScurrentMarker = L.marker([lat, long], { icon: pumpIcon });
                    LScurrentMarker.addTo(map);
                    LScurrentMarker.bindPopup(text + " LS");
                    LScurrentMarker.bindTooltip(text + " LS").openTooltip();
                } else {
                    WWTPcurrentMarker = L.marker([lat, long], { icon: wwtpIcon });//wwtpIcon
                    WWTPcurrentMarker.addTo(map);
                    WWTPcurrentMarker.bindPopup(text);
                    WWTPcurrentMarker.bindTooltip(text).openTooltip();
                }
            } catch (e) {
                console.log(e);
            }
        }
        map.on('dblclick', async function (e) {
            closeSummaryCard('summaryCard');
            runTrace(e.latlng.lng, e.latlng.lat)
        });

        function gameClickHandler(e) {
            // Get the lat and lng of the clicked point
            var clickedLat = e.latlng.lat;
            var clickedLng = e.latlng.lng;

            // Check if currentLocationIcon already exists
            if (currentLocationIcon) {
                // Move the currentLocationIcon to the clicked location
                animateMarker(currentLocationIcon, e.latlng, 1000);
            } else {
                // Create currentLocationIcon if it doesn't exist
            }
            checkForGoldCollection(currentLocationIcon.getLatLng());
        }

        // Additional logic here (e.g., checking if the click is along the flush path)

        function animateMarker(marker, destination, duration) {
            var startLatLng = marker.getLatLng();
            var endLatLng = new L.LatLng(destination.lat, destination.lng);

            var startTime = Date.now();
            var timer = setInterval(function () {
                var currentTime = Date.now();
                var progress = (currentTime - startTime) / duration;

                if (progress > 1) {
                    progress = 1;
                    clearInterval(timer);
                }

                var lat = startLatLng.lat + (endLatLng.lat - startLatLng.lat) * progress;
                var lng = startLatLng.lng + (endLatLng.lng - startLatLng.lng) * progress;

                marker.setLatLng([lat, lng]);

                if (progress === 1) {
                    clearInterval(timer);
                }
            }, 10); // The smaller this number, the smoother the animation
        }
        // Event Listeners
        map.on('zoomend', checkZoomLevel);
        checkZoomLevel(); // Initial check
        var searchMarker = null;
        var geocoder = L.Control.geocoder({
            position: 'topright',
            defaultMarkGeocode: false
        }).addTo(map);

        geocoder.on('markgeocode', function (e) {
            var bbox = e.geocode.bbox;
            var latLng = e.geocode.center; // Latitude and Longitude of the searched location
            map.panTo(latLng);
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            // Add a new search marker
            searchMarker = L.marker(latLng).addTo(map).bindPopup(e.geocode.name).openPopup();

            // Clear previous GeoJSON layer
            removeAllLayer();
            runTrace(latLng.lng, latLng.lat)

        });
        document.getElementById('currentLocationButton').addEventListener('click', function () {
            map.locate({ setView: true, maxZoom: config.initialZoom });

            map.on('locationfound', function (e) {
                runTrace(e.latlng.lng, e.latlng.lat);
            });

            map.on('locationerror', function (e) {
                alert("Location access denied.");
            });
        });
        // Function to add gold markers
        function addGoldMarkers(geojsonData_) {
            clearAllGoldMarkers(); // Clear all gold markers before adding new ones
            geojsonData_.features.forEach(feature => {
                let startPoint = feature.geometry.coordinates[0];
                let goldMarker = L.marker([startPoint[1], startPoint[0]], { icon: gemIcon }).addTo(map);
                goldMarkers.push(goldMarker);
            });
        }
        function checkForGoldCollection() {
            var someThresholdDistance = 15; // Threshold distance in meters
            var currentLocation = currentLocationIcon.getLatLng(); // Get current location of the toilet icon

            // Check only the first gold marker in the array (sequential collection)
            if (goldMarkers.length > 0) {
                var firstMarker = goldMarkers[0];

                if (firstMarker.getLatLng().distanceTo(currentLocation) < someThresholdDistance) {
                    // If within the threshold distance, remove the first gold marker and update the score
                    map.removeLayer(firstMarker);
                    goldMarkers.shift(); // Remove the first marker from the array
                    updateScore(); // Update the player's score
                }
            }
        }
        function clearAllGoldMarkers() {
            goldMarkers.forEach(marker => {
                map.removeLayer(marker); // Remove each marker from the map
            });

            goldMarkers = []; // Reset the goldMarkers array
        }
        // Assuming you have a function to update the player's score
        function updateScore() {
            score++; // Increment score
            document.getElementById('score').textContent = score; // Update score display
        }    
        function showScoreLabel(visible) {
            var scoreContainer = document.getElementById('scoreContainer');
            if (visible) {
                scoreContainer.style.display = 'block'; // Show the score label
            } else {
                scoreContainer.style.display = 'none'; // Hide the score label
            }
        }        
    </script>
</body>

</html>
