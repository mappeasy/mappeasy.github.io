<html>

<head>
    <title>Flush FLow Frenzy: Follow the FLush </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="flushflow.css" />
    <!-- Leaflet Esri Plugin -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet"></script>
    <script src="https://unpkg.com/leaflet-ant-path" type="text/javascript"></script>
    <!-- Your JavaScript file -->
    <script src="script.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder"></script>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-BHSNBW8NK6"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-BHSNBW8NK6');
        </script>    
</head>

<body>
    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Following The Flush . . .</h2>
                <i class="fa fa-cog fa-spin fa-5x fa-fw"></i>
            </div>
            <div class="modal-body">
                <p style="font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <span style="color: #007bff; font-weight: bold;">Dive into Houston's hidden water kingdom!</span> Imagine <span style="font-weight: bold;">39 bustling wastewater castles</span> and <span style="font-weight: bold; color: #28a745;">2 special rain spas.</span>
                    <br />Picture over <span style="font-weight: bold;">380 water elevators</span> (no boring music here!) and a whopping <span style="font-weight: bold;">6,500 miles of watery roads,</span> from tiny 2-inch streams to huge 144-inch rivers.
                    <br />These pipes could stretch <span style="font-weight: bold;">from DC to Seattle and back</span> â€“ it's a mega water slide under your feet!
                    <br /> <span style="color: #dc3545; font-weight: bold;">Houston's not just a city, it's an epic H2O adventure land!</span> ðŸŒŠðŸš€ðŸ’¦
                </p>
            </div>
        </div>
    </div>
    <div id="summaryCard" class="summary-card">
        <div class="card-note" id="card-note-notification">From Flush to Final Splash! Adventure Begins</div>
        <!-- Add your note text here -->
        <div class="card-content">
            <h2 id="cardHeader">Where Flush Goes</h2>
            <sub id="notification">
                <font color='gray'><i>"Imagine this: In our underground water race, the flow zooms from 1 to 3 feet per second in the Gravity Main, like a lazy river, and then dashes from 2 to 8 feet per second in the Forcemain, like a super-speedy waterslide!</i></font>
            </sub>
            <hr />
            <p id="generalRoute_container"><strong>General Route:</strong> <span id="generalRoute">0 feet</span></p>
            <p id="distanceTraveled_container"><strong>Zooming Adventure:</strong> <span id="distanceTraveled">0
                    feet</span></p>
            <p id="timeToWWTP_container"><strong>Speedy Splash:</strong> <span id="timeToWWTP">0 hours</span></p>
            <p id="communitiesPassed_"><strong>Epic Journey of the Flush:</strong></p>
            <ul id="communitiesPassed">
                <!-- List items will be added dynamically -->
            </ul>
            <button onclick="closeSummaryCard('summaryCard');">Close</button>

        </div>
    </div>
    <div id="aboutMe" class="summary-card">
        <div class="card-note">Flush Flow Frenzy: Follow the Flush</div>
        <!-- Add your note text here -->
        <div class="card-content">
            <h2 id="cardHeader_about">About this Project</h2>
            <p id="generalRoute_container_about"><span id="generalRoute_about">This is purely for learning purpose â€“ a chance to track the splashy journey of our flushes from the loo to the lab! It's our way of teaching the kiddos the swirling path of their flush â€“ from toilet twirls to treatment thrills! ðŸš½ðŸ’¦ðŸŽ¢</span></p>
            <p id="distanceTraveled_container_about"><span id="distanceTraveled_about">Made with <i class="fa-solid fa-heart" style="color: #d31717;"></i> by WWO<br></span></p>
            <button onclick="closeSummaryCard('aboutMe')">Close</button>
        </div>
    </div>    
    <div id="splashShow" class="summary-card">
        <div class="card-note">Flush Flow Frenzy: Follow the Flush</div>
        <!-- Add your note text here -->
        <div class="card-content">
            <h2 id="cardHeader_about">Flushing ðŸ’©: Super Simple </h2>
            <p id="generalRoute_container_about"><span id="generalRoute_about"> <b style="color: red;">Double Tap or double click</b> on any spot to start a flush adventure, or hit the blue top-left button to whoosh away from where you are!ðŸš½ðŸ’¦ðŸŽ¢</span></p>
            <p id="distanceTraveled_container_about"><span id="distanceTraveled_about">Made with <i class="fa-solid fa-heart" style="color: #d31717;"></i> by WWO<br></span></p>
            <button onclick="closeSummaryCard('splashShow')">Close</button>
        </div>
    </div>      
    <div id="map"></div>
    <button id="currentLocationButton" title="Your Current Location"><i class="fa fa-location"></i></button>
    <button id="lastFlushButton"><i class="fas fa-water"></i> Last Flush</button>


    <script>
        // Configuration
        const config = {
            esri_basemap: false,
            mapCenter: [29.76, -95.37], // Houston's coordinates
            initialZoom: 13,
            layerTransparency: 0.4,
            minimumZoomLevel: 16,
            zoomControl: false,
            geoJsonStyle: {
                color: "#0000FF",
                weight: 8,
                opacity: 0.4
            }
        };
        document.addEventListener('DOMContentLoaded', function() {
            var modalHeader = document.getElementById('summaryCard');
            var loadingModal = document.getElementById('cardHeader');
        
            if (modalHeader && loadingModal) {
                makeDraggable('summaryCard','cardHeader');
            } else {
                console.error("Elements not found");
            }
        });        
        
        var mainData = {
        };
        closeSummaryCard('aboutMe');
        closeSummaryCard('summaryCard');
        var currentGeoJsonLayer = null;
        var currentLocationIcon = null;
        var currentGeoJsonLayerLine = null;
        document.getElementById("loadingModal").style.display = "none";
        // Initialize Map
        const map = L.map('map', {
            center: config.mapCenter,
            zoom: config.initialZoom,
            zoomControl: config.zoomControl // Disable the default zoom control
        });
        // Add a toilet marker
        var toiletIcon = L.divIcon({
            className: 'fa-icon',
            html: '<i class="fa-solid fa-poo fa-3x fa-beat" style="color: #8b4513;"></i>',
            iconSize: [30, 30], // size of the icon in pixels
            iconAnchor: [10, 20] // point of the icon which will correspond to marker's location
            });     

        var pumpIcon = L.divIcon({
            className: 'fa-icon',
            html: '<i class="fa-solid fa-pump-soap fa-beat fa-3x" style="color: #ed0c0c;"></i>',
            iconSize: [30, 30], // size of the icon in pixels
            iconAnchor: [10, 20] // point of the icon which will correspond to marker's location
            });   
        var wwtpIcon = L.divIcon({
            className: 'fa-icon',
            html: '<i class="fa-solid fa-city  fa-3x  fa-beat" style="color: #120FE6;"></i>',
            iconSize: [30, 30], // size of the icon in pixels
            iconAnchor: [10, 20] // point of the icon which will correspond to marker's location
            });           
        
        if (config.esri_basemap === true) {
            L.esri.basemapLayer('Streets').addTo(map);
        }
        else {
            //L.esri.basemapLayer('Streets').addTo(map);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Not for official use or planning | <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11', // or any other Mapbox style
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoibWF0aGhvYW5nIiwiYSI6ImNsc3I2djRwYjE1ODYyanBiZ2E1djltbDkifQ.nqI0jOWkftuTKgHx6m8mcw' // Replace with your Mapbox access token
            }).addTo(map);
        }
        // Layer Definitions
        const gravityMainLayer = createEsriLayer("https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer", [1], config.layerTransparency);
        const forceMainLayer = createEsriLayer("https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer", [4], config.layerTransparency);
        const lsWwtpLayer = createEsriLayer('https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', [16], config.layerTransparency);
        const lsWwtpLabelLayer = createEsriLayer('https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', [17], config.layerTransparency);


        L.Control.MapLegend = L.Control.extend({
            onAdd: function (map) {
                var div = L.DomUtil.create('div', 'info legend');
                div.innerHTML += '<h4>Map Legend</h4>';
                div.innerHTML += '<i style="background: #0000FF; width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.4;"></i> Flush Flow<br>';
                div.innerHTML += '<i class="fa fa-map-marker" aria-hidden="true" style="color: #2E85CB;"></i> LS/WWTP<br>';
                div.innerHTML += '<b>Double Click Or Type Address</b><br>';
                div.innerHTML += '<b>Not for official use - Fun only</b><br>';
                var button = L.DomUtil.create('button', 'legend-button');
                button.innerHTML = 'More Info';
                button.style.backgroundColor = '#007bff';
                button.style.color = 'white';
                button.style.border = 'none';
                button.style.borderRadius = '4px';
                button.style.padding = '5px 10px';
                button.style.marginTop = '10px';
                button.style.cursor = 'pointer';
                button.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
                button.onclick = function() {
                    event.stopPropagation();
                    closeSummaryCard('summaryCard');
                    document.getElementById('aboutMe').style.display = 'block';
                };
                div.appendChild(button);
                return div;
            }
        });

        L.control.mapLegend = function (opts) {
            return new L.Control.MapLegend(opts);
        }
        L.control.mapLegend({ position: 'bottomleft' }).addTo(map);
        // Utility Functions
        function createEsriLayer(url, layers, opacity) {
            return L.esri.dynamicMapLayer({ url, layers, opacity }).addTo(map);
        }
        document.getElementById('lastFlushButton').addEventListener('click', function () {
            if (Object.keys(mainData).length === 0) {
                var NoData = {
                    header: "Ready, Set, Flush! Double Click/Tap anywhere on the map to start a watery whirlwind adventure!", // Add your header text here
                    distance: 'Flush to see the journey',
                    time: 'Flush to travel in time',
                    communities: ['Traveling']
                };
                showSummaryCard(NoData, true);
            } else {
                showSummaryCard(mainData, false);
            }
        });
        function showSummaryCard(data, notification) {
            if (notification === false) {
                document.getElementById('distanceTraveled_container').style.display = '';
                document.getElementById('timeToWWTP_container').style.display = '';
                document.getElementById('communitiesPassed').style.display = '';
                document.getElementById('card-note-notification').style.display = '';
                document.getElementById('notification').style.display = '';
                document.getElementById('communitiesPassed_').style.display = '';
                document.getElementById('generalRoute_container').style.display = '';
                // Populate the summary card with data
                // Populate the summary card with data
                document.getElementById('cardHeader').textContent = data.header;
                document.getElementById('distanceTraveled').textContent = data.distance;
                document.getElementById('timeToWWTP').textContent = data.time;
                document.getElementById('generalRoute').textContent = data.generalRoute;
                document.getElementById('communitiesPassed').innerHTML = data.communities.map(c => `<li>${c}</li>`).join('');
            } else {
                document.getElementById('cardHeader').textContent = data.header;
                document.getElementById('distanceTraveled_container').style.display = 'none';
                document.getElementById('timeToWWTP_container').style.display = 'none';
                document.getElementById('communitiesPassed').style.display = 'none';
                document.getElementById('card-note-notification').style.display = 'none';
                document.getElementById('notification').style.display = 'none';
                document.getElementById('communitiesPassed_').style.display = 'none';
                document.getElementById('generalRoute_container').style.display = 'none';
            }
            // Show the summary card
            document.getElementById('summaryCard').style.display = 'block';
        }

        function closeSummaryCard(cardName) {
            document.getElementById(cardName).style.display = 'none';
        }

        function showModal() {
            document.getElementById('loadingModal').style.display = 'flex'; // Use 'flex' to enable flexbox properties
        }
        function hideModal() {
            document.getElementById('loadingModal').style.display = 'none';
        }

        function removeAllLayer(){
            try {
                if (currentGeoJsonLayer !== null) map.removeLayer(currentGeoJsonLayer);
                if (LScurrentMarker !== null) map.removeLayer(LScurrentMarker);
                if (WWTPcurrentMarker !== null) map.removeLayer(WWTPcurrentMarker);
                if (currentGeoJsonLayerLine !== null) map.removeLayer(currentGeoJsonLayerLine);
                if (currentLocationIcon !== null) map.removeLayer(currentLocationIcon);
                if (searchMarker !== null) map.removeLayer(searchMarker);
                LScurrentMarker = null;
                WWTPcurrentMarker = null;
                currentGeoJsonLayer = null;
                currentGeoJsonLayerLine = null;
                currentLocationIcon = null;
            } catch (e) {
                console.log(e);
            }
        }
        // Function to add GeoJSON to the map
        function addGeoJsonToMap(geojsonData) {

            // Remove the previous GeoJSON layer if it exists
            removeAllLayer();

            currentGeoJsonLayer = L.geoJSON(geojsonData, {
            style: function(feature) {
                return {
                    color: config.geoJsonStyle.color, // Example color
                    weight: config.geoJsonStyle.weight,
                    opacity: config.geoJsonStyle.opacity,
                    lineCap: 'round',
                    dashArray: '10, 20',
                    dashOffset: '0',
                    className: (feature.properties.SUBTYPECD ==1 || feature.properties.SUBTYPECD ==2 ) ? 'heavy-traffic-animation' : 'light-traffic-animation'
                };
            }
            }).addTo(map); 

            currentGeoJsonLayerLine = L.geoJSON(geojsonData, {
                style: function (feature) {
                    return {
                        color: "#0000FF", 
                        weight: 12,       // Thickness of the line
                        opacity: 0.2     // Transparency
                    };
                }
            }).addTo(map);            
                // Zoom to the bounds of the GeoJSON layer
            if (geojsonData.features && geojsonData.features.length > 0) {
                var bounds = currentGeoJsonLayer.getBounds();
                map.fitBounds(bounds);
            }
            let flusingPoint = geojsonData.features[0].geometry.coordinates[0];
            currentLocationIcon= L.marker([flusingPoint[1], flusingPoint[0]], { icon: toiletIcon })
                .addTo(map)
                .bindPopup('Your flush starts here!')
                //.bindTooltip('flush Location', { permanent: true, direction: 'top' })
                .bindTooltip("Hey!I'm your flush")
                .openTooltip();     
        }

        function checkZoomLevel() {
            const currentZoom = map.getZoom();
            if (currentZoom < config.minimumZoomLevel) {
                setLayerVisibility(0); // Hide layers
            } else {
                setLayerVisibility(config.layerTransparency); // Show layers
            }
        }

        function setLayerVisibility(opacity) {
            gravityMainLayer.setOpacity(opacity);
            forceMainLayer.setOpacity(opacity);
            lsWwtpLayer.setOpacity(opacity);
            lsWwtpLabelLayer.setOpacity(opacity);
        }
        var LScurrentMarker = null; // This will hold the current marker
        var WWTPcurrentMarker = null; // This will hold the current marker
        async function runTrace(lng, lat) {
            showModal();
            // Remove the previous GeoJSON layer if it exists
            await removeAllLayer();
            try {
                const initialUnitId = await findNearestFeatureUnitId(lng, lat);
                if (initialUnitId) {
                    //15: LS
                    const result = await queryFeaturesAndGetGeoJson(initialUnitId, 98);
                    if (result && result.geojson) {
                        let street = [];
                        let generalRoute = "";
                        addGeoJsonToMap(result.geojson);
                        hideModal();
                        //find first LiftStation
                        let firstLS = result.stopPoints.find(obj => obj.type === 15);
                        if (firstLS != null) {
                            firstLS = await findLSWWTP(firstLS.type, firstLS.unitID);
                        }

                        let lastStopPoint = result.stopPoints[result.stopPoints.length - 1];
                        let lastStopPoint_Result = await findLSWWTP(lastStopPoint.type, lastStopPoint.unitID);
                        if (lastStopPoint_Result == null) { //get
                            lastStopPoint_Result = await findLSWWTP(lastStopPoint.type, lastStopPoint.unitID);
                            for (let i = result.geojson.features.length - 1; i >= 0; i--) {
                                lastStopPoint_Result = await findLSWWTP(result.geojson.features[i].properties.MAINCOMP2, result.geojson.features[i].properties.UNITID2);
                                if (lastStopPoint_Result != null) {
                                    break;
                                }
                            }
                        }
                        if (firstLS == null) {
                            generalRoute = "Guess what happens when you flush? It's like a water race to the 'Clean Team Castle', zooming directly to the treatment plant " + lastStopPoint_Result.info.FACILITYNAME + " at " + lastStopPoint_Result.info.ADDRESS +"for a super splashy makeover";

                        } else {
                            generalRoute = "Every time you flush, it's like a mini-water slide adventure for the water! It zooms down to the 'Super Lift Station' " + firstLS.info.FACILITYNAME + " at " + firstLS.info.ADDRESS + "  then whooshes through secret tunnels all the way to the 'Clean-up Club' WWTP at  " + lastStopPoint_Result.info.ADDRESS;
                            placeMarker(firstLS.location.y, firstLS.location.x, firstLS.info.FACILITYNAME, "LS");
                        }
                        await placeMarker(lastStopPoint_Result.location.y, lastStopPoint_Result.location.x, lastStopPoint_Result.info.FACILITYNAME, "WWTP")
                        let calculation = await calculateRoute(result.geojson.features);
                        mainData = {
                            header: "Near By " + result.geojson.features[0].properties.ADDRESS, // Add your header text here
                            generalRoute: generalRoute,
                            distance: `The flush travels ${calculation.total_len_ft} feet (${calculation.total_len_mi}  miles) through the sewer network before reaching the COH treatment facility.`,
                            time: `Your flush goes on a wild ride! It could zip to the treatment plant in just  ${calculation.total_hour_min} hours, , or take a leisurely journey up to ${calculation.total_hour_max} hours during sunny weather fun times.`,
                            communities: getUniqueStreetNames(result.geojson.features)
                        };
                        showSummaryCard(mainData, false);
                    } else {
                        console.log('No GeoJSON data found.');
                    }
                } else if (initialUnitId == null || initialUnitId == "") {
                    var noConnection = {
                        header: "Likely, you are not connecting to any City of Houston Sanitary Sewer System", // Add your header text here
                        distance: 'Not Applicable',
                        time: 'Not Applicable',
                        communities: ['Not Available']
                    };
                    hideModal();
                    showSummaryCard(noConnection, true);
                }
            } catch (error) {
                console.error('Error:', error);
            }

        }
        function placeMarker(lat, long, text, type) {
            try {
                if (type == "LS") {
                    markerOptions = { icon: new L.Icon.Default() };
                    LScurrentMarker = L.marker([lat, long], { icon: pumpIcon });
                    LScurrentMarker.addTo(map);
                    LScurrentMarker.bindPopup(text +" LS");
                    LScurrentMarker.bindTooltip(text +" LS").openTooltip();
                } else {
                    WWTPcurrentMarker = L.marker([lat, long], { icon: wwtpIcon });//wwtpIcon
                    WWTPcurrentMarker.addTo(map);
                    WWTPcurrentMarker.bindPopup(text);
                    WWTPcurrentMarker.bindTooltip(text).openTooltip();
                }
            } catch (e) {
                console.log(e);
            }
        }
        map.on('dblclick', async function (e) {
            closeSummaryCard('summaryCard');
            runTrace(e.latlng.lng, e.latlng.lat)
        });
        // Event Listeners
        map.on('zoomend', checkZoomLevel);
        checkZoomLevel(); // Initial check
        var searchMarker = null;
        var geocoder = L.Control.geocoder({
            position: 'topright',
            defaultMarkGeocode: false
        }).addTo(map);

        geocoder.on('markgeocode', function (e) {
            var bbox = e.geocode.bbox;
            var latLng = e.geocode.center; // Latitude and Longitude of the searched location
            map.panTo(latLng);
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            // Add a new search marker
            searchMarker = L.marker(latLng).addTo(map).bindPopup(e.geocode.name).openPopup();

            // Clear previous GeoJSON layer
            removeAllLayer();
            runTrace(latLng.lng, latLng.lat)

        });
        document.getElementById('currentLocationButton').addEventListener('click', function () {
            map.locate({ setView: true, maxZoom: config.initialZoom });

            map.on('locationfound', function (e) {
                runTrace(e.latlng.lng, e.latlng.lat);
            });

            map.on('locationerror', function (e) {
                alert("Location access denied.");
            });
        });
    </script>
</body>

</html>
