<!DOCTYPE html>
<html>

<head>
    <title>Local Assets With Local Easy Peasy Map tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Include Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #mapid {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .custom-layer-switcher {
            position: absolute;
            bottom: 40px;
            /* Adjusted to make room for the toggle button */
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            padding: 5px;
            z-index: 1000;
            display: none;
            /* Initially hidden */
        }

        .layer-group {
            margin-bottom: 5px;
        }

        .layer-group-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .toggle-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1001;
            cursor: pointer;
            background-color: rgba(0, 60, 136, 0.7);
            color: white;
            padding: 10px 15px;
            /* Increased padding */
            border-radius: 8px;
            /* Slightly larger border radius */
            font-size: 20px;
            /* Larger font size */
            width: auto;
            /* Auto width to accommodate larger text */
            height: auto;
            /* Auto height for flexible sizing */
        }

        .search-box {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 5px;
            display: flex;
            max-width: 400px;
            /* Maximum width */
        }

        .search-input {
            padding: 5px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
            margin-right: 5px;
        }

        .search-button {
            padding: 5px 10px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            background: rgba(76, 175, 80, 0.8);
            color: white;
            cursor: pointer;
            display: none;
        }

        /* Responsive adjustments for mobile screens */
        @media (max-width: 600px) {
            .search-box {
                left: 10px;
                /* Adjusted to start a bit away from the left edge */
                right: 10px;
                /* Adjusted to provide right margin */
                top: 10px;
                transform: none;
                /* Remove the transform property */
            }

            .search-input {
                width: calc(100% - 20px);
                /* Full width minus the left and right padding */
                display: block;
                /* Ensure the input is visible */
                margin-bottom: 5px;
                /* Add margin at the bottom of the input */
            }

            .search-button {
                display: none;
                /* Keep the button hidden */
            }
        }
    </style>
</head>

<body>
    <div id="mapid"></div>
    <div class="search-box">
        <input type="text" id="search-input" class="search-input" placeholder="Enter an address">
        <button id="search-button" class="search-button">Search</button>
    </div>

    <div class="toggle-button" id="toggle-button">Layers</div>
    <div class="custom-layer-switcher" id="layer-switcher">
        <div class="layer-group">
            <div class="layer-group-title">Layers</div>
            <div><input type="checkbox" id="gravity-main-checkbox" checked> Gravity Main</div>
            <div><input type="checkbox" id="gravity-main-label-checkbox" checked> Gravity Main Label</div>
            <div><input type="checkbox" id="manhole-checkbox" checked> Manhole</div>
            <div><input type="checkbox" id="manhole-label-checkbox" checked> Manhole Label</div>
            <div><input type="checkbox" id="layer5-checkbox" checked> LS/WWTP</div>
            <div><input type="checkbox" id="layer6-checkbox" checked> LS/WWTP Label</div>
            <!-- Add more layers as needed -->
        </div>
    </div>
    <!-- Include Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet"></script>
    <script>
        var currentMarker = null; // Variable to store the current marker
// SVG code for the person icon
    var personSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="blue" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="8" r="4"></circle> <!-- Head -->
                    <line x1="12" y1="12" x2="12" y2="20"></line> <!-- Body -->
                    <line x1="12" y1="20" x2="9" y2="23"></line> <!-- Left leg -->
                    <line x1="12" y1="20" x2="15" y2="23"></line> <!-- Right leg -->
                    <line x1="12" y1="14" x2="9" y2="16"></line> <!-- Left arm -->
                    <line x1="12" y1="14" x2="15" y2="16"></line> <!-- Right arm -->
                </svg>
                `;
    // Custom divIcon for the person-shaped marker
    var personIcon = L.divIcon({
        className: 'custom-person-icon',
        html: personSvg,
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
    });                
        // Create Leaflet Map
        var map = L.map('mapid').setView([29.7604, -95.3698], 11);

        // Add OpenStreetMap Base Layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        //L.esri.dynamicMapLayer
        // Add the GIS layers
        var gravityMainLayer = L.esri.dynamicMapLayer({ url: "https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer", layers: [1] }).addTo(map);;
        var gravityMainLabelLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [2] }).addTo(map);;
        var manholeLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [12] }).addTo(map);;
        var manholeLabelLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [13] }).addTo(map);;
        var lsWwtpLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [16] }).addTo(map);;
        var lsWwtpLabelLayer = L.esri.dynamicMapLayer({ url: 'https://geogimsms.houstontx.gov/arcgis/rest/services/HW/WasteWaterUtilities_gx/MapServer', layers: [17] }).addTo(map);;

        // Create a Layer Group for your custom layers
        var customLayers = L.layerGroup().addTo(map);
        var overlays = {
            "Manhole Label": manholeLabelLayer,
            "Gravity Main Label": gravityMainLabelLayer,
            "LiftStation/WWTP Label": lsWwtpLabelLayer,
            "Manhole": manholeLayer,
            "Gravity Main": gravityMainLayer,
            "LiftStation/WWTP": lsWwtpLayer,
        };

        L.control.layers(null, overlays).addTo(map);
        // Example: Adding a custom Tile Layer (replace with your own)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(customLayers);

        // Handle Search (update this part for Leaflet)
        function handleSearch() {
            var address = document.getElementById('search-input').value;
            fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address))
                .then(function (response) { return response.json(); })
                .then(function (json) {
                    if (json.length > 0) {
                        var latlng = L.latLng(json[0].lat, json[0].lon);
                        map.setView(latlng, 17);

                        // Remove the existing marker if there is one
                        if (currentMarker) {
                            map.removeLayer(currentMarker);
                        }

                        // Create a new marker and add it to the map
                        currentMarker = L.marker(latlng).addTo(map);
                        currentMarker.bindPopup('<b>Address:</b><br>' + json[0].display_name).openPopup();
                    } else {
                        alert('Address not found.');
                    }
                })
                .catch(function (error) {
                    alert('Error during search: ' + error.message);
                });
        }

        // Add Event Listeners (similar to your existing code)
        document.getElementById('search-button').addEventListener('click', handleSearch);
        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
        function updateLayerVisibility() {
            var currentZoom = map.getZoom();
            console.log("Current Zoom Level:", currentZoom);
            var isVisibleFeature = currentZoom >= 15;
            var isVisibleLabel = currentZoom >= 17;

            // Toggle each layer based on zoom level
            gravityMainLayer.setOpacity(isVisibleFeature ? 1 : 0);
            manholeLayer.setOpacity(isVisibleFeature ? 1 : 0);
            lsWwtpLayer.setOpacity(isVisibleFeature ? 1 : 0);
            gravityMainLabelLayer.setOpacity(isVisibleLabel ? 1 : 0);
            manholeLabelLayer.setOpacity(isVisibleLabel ? 1 : 0);
            lsWwtpLabelLayer.setOpacity(isVisibleLabel ? 1 : 0);
        }
        // Attach the function to the map's zoomend event
        map.on('zoomend', updateLayerVisibility);

        // Call the function initially to set the correct visibility
        updateLayerVisibility();
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
        // Function to show the user's position
        function showPosition(position) {
            var userLat = position.coords.latitude;
            var userLng = position.coords.longitude;
            var userLatLng = L.latLng(userLat, userLng);

            if (currentMarker) {
                currentMarker.setLatLng(userLatLng);
            } else {
                currentMarker = L.marker(userLatLng, {icon: personIcon}).addTo(map);
            }

            map.setView(userLatLng, 17);
        }
        // Function to handle location errors
        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }
        // Call locateUser to get the initial location
        locateUser();

        // Set up a watcher to update the location as the user moves
        var watchID = navigator.geolocation.watchPosition(showPosition, showError, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });               
    </script>
</body>

</html>
